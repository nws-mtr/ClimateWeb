<!DOCTYPE html>
<html lang="en">
<head>
<!-- station_payloads.json lives alongside this file in the web/ directory.
     To run locally, serve the web/ folder with any static file server (for example: `cd web && python -m http.server`)
     and open index.html in your browser. -->
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title></title>
<style type="text/css">:root {
      --bg: #f1f5fb;
      --panel: #ffffff;
      --ink: #0f172a;
      --muted: #5c6676;
      --border: #d9e2ec;
      --accent: #2d6cdf;
      --accent-soft: #e6edff;
      --shadow: 0 18px 42px rgba(15, 23, 42, 0.12);
      --below: #3b82f6;
      --near: #0ea5e9;
      --above: #16a34a;
      --missing: #94a3b8;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Avenir Next", "Segoe UI", "Helvetica Neue", sans-serif;
      background: radial-gradient(circle at 20% 20%, #f7f9fd 0, #e9edf7 35%, #eef2f7 100%);
      color: var(--ink);
      line-height: 1.6;
      min-height: 100vh;
    }

    .page {
      max-width: 100% auto;
      margin: 0 auto;
      padding: 32px 20px 48px;
      margin-top: -3rem;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      margin-bottom: 18px;
    }

    .title-block {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .eyebrow {
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-size: 12px;
      color: var(--muted);
      margin: 0;
      font-weight: 700;
    }

    h1 {
      margin: 0;
      font-size: 28px;
      letter-spacing: -0.5px;
    }

    .lede {
      margin: 0;
      color: var(--muted);
      max-width: 800px;
    }

    .controls {
      background: var(--panel);
      border: 2px solid var(--border);
      box-shadow: var(--shadow);
      border-radius: 14px;
      padding: 12px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .control-group {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }

    label {
      font-weight: 600;
      color: var(--muted);
      font-size: 14px;
    }

    input[type="search"],
    select {
      border: 1px solid var(--border);
      background: #fdfefe;
      border-radius: 10px;
      padding: 10px 12px;
      font-size: 15px;
      min-width: 220px;
      color: var(--ink);
      box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6);
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input[type="search"]:focus,
    select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(45, 108, 223, 0.12);
    }

    button {
      border: 1px solid var(--border);
      background: linear-gradient(135deg, var(--accent), #214ea6);
      color: #fff;
      border-radius: 10px;
      padding: 10px 14px;
      font-weight: 700;
      cursor: pointer;
      letter-spacing: 0.01em;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      box-shadow: 0 10px 25px rgba(45, 108, 223, 0.25);
    }

    button:hover {
      transform: translateY(-1px);
    }

    button:focus-visible,
    input:focus-visible,
    select:focus-visible {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }

    .sort-direction {
      background: var(--panel);
      color: var(--ink);
      border: 1px solid var(--border);
      box-shadow: none;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.01em;
    }

    .status-below {
      background: rgba(59, 130, 246, 0.12);
      color: #f6703b;
    }

    .status-near {
      background: rgba(14, 165, 233, 0.14);
      color: #0f4f7f;
    }

    .status-above {
      background: rgba(22, 163, 74, 0.14);
      color: #166534;
    }

    .status-missing {
      background: rgba(148, 163, 184, 0.15);
      color: #334155;
    }

    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .station-card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 12px;
      position: relative;
      overflow: hidden;
    }

    .station-card.pinned {
      border-color: var(--accent);
      box-shadow: 0 12px 30px rgba(45, 108, 223, 0.25);
    }

    .pin-button {
      position: absolute;
      bottom: 12px;
      right: 12px;
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: rgba(255, 255, 255, 0.92);
      color: var(--muted);
      display: grid;
      place-items: center;
      cursor: pointer;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.12);
      transition: color 0.2s ease, border-color 0.2s ease, background-color 0.2s ease, box-shadow 0.2s ease;
      z-index: 1;
    }

    .pin-button:hover {
      color: var(--accent);
      border-color: var(--accent);
      box-shadow: 0 10px 22px rgba(45, 108, 223, 0.25);
    }

    .pin-button.is-pinned {
      color: var(--accent);
      background: var(--accent-soft);
      border-color: var(--accent);
      box-shadow: 0 10px 22px rgba(45, 108, 223, 0.25);
    }

    .pin-icon {
      position: absolute;
      width: 16px;
      height: 16px;
      top: 6px;
      left: 7px;
      display: block;
      background-color: currentColor;
      -webkit-mask: url('images/pin-3-svgrepo-com.svg') center/contain no-repeat;
      mask: url('images/pin-3-svgrepo-com.svg') center/contain no-repeat;
    }

    .station-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(45, 108, 223, 0.04), transparent 30%, rgba(46, 160, 255, 0.03));
      pointer-events: none;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      gap: 10px;
      align-items: center;
      position: relative;
      z-index: 1;
    }

    .card-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .current-temp {
      display: inline-flex;
      align-items: baseline;
      gap: 6px;
      font-weight: 700;
      color: var(--ink);
      padding: 6px 10px;
      border: 1px solid #e3e8f0;
      border-radius: 10px;
      background: #f7f9fd;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
      white-space: nowrap;
    }

    .current-label {
      text-transform: uppercase;
      letter-spacing: 0.06em;
      font-size: 16px;
      color: var(--muted);
      font-weight: 600;
    }

    .current-value {
      font-size: 18px;
      letter-spacing: -0.2px;
      font-weight: 600;
    }

    .station-name {
      margin: 0;
      font-size: 18px;
      font-weight: 650;
      letter-spacing: -0.2px;
      color:#000000;
    }

    .station-id {
      font-size: 13px;
      text-transform: uppercase;
      color: var(--muted);
      font-weight: 700;
      letter-spacing: 0.08em;
    }

    .meta {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 18px;
      color: var(--muted);
      font-size: 12px;
      position: relative;
      z-index: 1;
    }

    .meta span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: -8px;
      padding: 5px 8px;
      background: #f6f8fb;
      border-radius: 10px;
      border: 1px solid #edf1f7;
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 6px;
      position: relative;
      z-index: 1;
    }

    .card-footer {
      margin-top: -3px;
      margin-bottom: -6px;
      display: flex;
      justify-content: left;
    }

    .map-link {
      font-size: 12px;
      font-weight: 500;
      color: var(--accent);
      text-decoration: none;
      padding: 5px 8px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: #f7f9fd;
      transition: color 0.15s ease, box-shadow 0.15s ease, transform 0.15s ease;
    }

    .map-link:hover {
      color: #1d4ed8;
      box-shadow: 0 8px 20px rgba(45, 108, 223, 0.18);
      transform: translateY(-1px);
    }

    .map-link.disabled {
      color: var(--muted);
      pointer-events: none;
      opacity: 0.6;
    }

    .metric {
      padding: 10px 12px;
      border-radius: 12px;
      border: 2px solid #edf0f5;
      background: #fbfcfe;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-height: 72px;
    }

    .metric-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--muted);
      font-weight: 700;
    }

    .metric-sub-label {
      display: grid;
      justify-content: right;
      font-size: 10px;
      letter-spacing: 0.06em;
      color: var(--muted);
      font-weight: 400;
      margin-top: -24px;
      margin-right: -1px;
    }

    .metric-value {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.2px;
    }

    .metric.status-below {
      background: rgba(246, 112, 59, 0.122);
      border-color: #edf0f5;
    }

    .metric.status-near {
      background: rgba(14, 165, 233, 0.12);
      border-color: #edf0f5;
    }

    .metric.status-above {
      background: rgba(22, 163, 74, 0.12);
      border-color: #edf0f5;
    }

    .metric.status-missing {
      background: rgba(121, 121, 121, 0.164);
      border-color: #edf0f5;
    }

    .notes {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 16px;
      margin-top: 8px;
    }

    .notes-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .notes-body {
      margin-top: 10px;
      color: var(--muted);
      line-height: 1.5;
    }

    .notes.collapsed .notes-body {
      display: none;
    }

    .notes-toggle {
      background: var(--panel);
      border: 1px solid var(--border);
      color: var(--ink);
      box-shadow: none;
      padding: 8px 12px;
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: #eef2f7;
      font-size: 12px;
      color: var(--muted);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .status-line {
      margin: 8px 0 14px;
      color: var(--muted);
      font-size: 14px;
      min-height: 20px;
    }

    .error {
      background: #fff4f4;
      border: 1px solid #f2b8b5;
      color: #8a1f15;
      padding: 10px 12px;
      border-radius: 10px;
      display: none;
    }

    .error.visible {
      display: block;
    }

    .empty-state {
      text-align: center;
      padding: 22px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: #f8fafd;
      color: var(--muted);
    }

    @media (max-width: 820px) {
      header {
        flex-direction: column;
      }
      .controls {
        flex-direction: column;
        align-items: flex-start;
      }
      .control-group {
        width: 100%;
      }
      input[type="search"] {
        width: 100%;
      }
    }
</style>
</head>
<body>
<div class="page">
<header>
<div class="title-block">
<p class="lede">Daily high, low, and rainfall <strong>since midnight</strong> and water year (Oct 1 - Sep 30) rainfall stats. All values update hourly.</p>

<p class="lede"><strong>***This page is experimental and automated. Data are preliminary and subject to additional quality control.***</strong></p>
</div>
</header>

<section aria-label="Filters and sorting" class="controls">
<div class="control-group"><label for="search">Search</label> <input autocomplete="off" id="search" name="search" placeholder="Type a station ID or name" type="search" /></div>

<div class="control-group"><label for="sortBy">Sort by</label> <select id="sortBy" name="sortBy"><option value="name">Station Name</option><option value="percentOfNorm">Percent of Normal</option><option value="dailyAccumIN">Precip Since Midnight</option><option value="airTempF">Current Temperature</option><option value="latitude">Latitude</option> </select><button aria-label="Toggle sort direction" class="sort-direction" id="sortDirection" type="button">Ascending</button></div>

<div class="control-group"><label>Generate Report</label><button id="printReport" type="button">Today So Far</button><button id="yesterdayReport" type="button">Yesterday</button></div>
</section>

<div aria-live="polite" class="status-line" id="status">&nbsp;</div>

<div class="error" id="error" role="alert">&nbsp;</div>

<main>
<section aria-live="polite" class="cards-grid" id="cards">&nbsp;</section>

<div class="empty-state" hidden="" id="emptyState">No stations to show yet.</div>
</main>

<section class="notes" id="notes">
<div class="notes-header">
<div class="title-block">
<p class="eyebrow">Guidance</p>

<h2 style="margin: 0;">Notes</h2>
</div>
<button aria-controls="notesBody" aria-expanded="true" class="notes-toggle" id="notesToggle" type="button">Hide</button></div>

<div class="notes-body" id="notesBody">
<p>This page summarizes daily climate observations per station, including temperature high/low and precipitation progress for the current water year (Oct 1 - Sep 30).</p>

<p><strong>Percent of normal</strong> compares the current water year precipitation to the normal. Values below 75% are flagged as below normal, 75-125% as near normal, and above 125% as above normal.</p>

<p>Missing data is indicated by a dash (&mdash;).</p>
</div>
</section>
</div>
<script>
    const state = {
      stations: [],
      meta: {},
      yesterdayStations: [],
      yesterdayMeta: {},
      sortKey: 'stid',
      sortDir: 'asc',
      filteredStations: [],
      pinned: new Set()
    };

    const cardsEl = document.getElementById('cards');
    const statusEl = document.getElementById('status');
    const errorEl = document.getElementById('error');
    const emptyStateEl = document.getElementById('emptyState');
    const searchInput = document.getElementById('search');
    const sortBy = document.getElementById('sortBy');
    const sortDirectionBtn = document.getElementById('sortDirection');
    const notesToggle = document.getElementById('notesToggle');
    const notesSection = document.getElementById('notes');
    const printButton = document.getElementById('printReport');
    const yesterdayButton = document.getElementById('yesterdayReport');

    function isMissing(value) {
      return value === 9999 || value === '9999' || value === null || value === undefined;
    }

    function isPinned(station) {
      return state.pinned.has(String(station?.stid));
    }

    function formatNumber(value, decimals = 0, suffix = '') {
      if (isMissing(value)) return '—';
      const num = Number(value);
      if (Number.isNaN(num)) return '—';
      const formatted = decimals !== null ? num.toFixed(decimals) : num.toString();
      return suffix ? `${formatted}${suffix}` : formatted;
    }

    function formatPercent(value) {
      if (isMissing(value)) return '—';
      const num = Number(value);
      if (Number.isNaN(num)) return '—';
      return `${Math.round(num)}%`;
    }

    function formatDate(value) {
      if (!value || isMissing(value)) return '—';
      const parsed = new Date(value);
      if (Number.isNaN(parsed.getTime())) return '—';
      return parsed.toLocaleString(undefined, {
        month: 'short',
        day: 'numeric',
        year: 'numeric',
        hour: 'numeric',
        minute: '2-digit',
        timeZoneName: 'short'
      });
    }

    function mapLink(station) {
      const lat = Number(station.latitude);
      const lon = Number(station.longitude);
      if (isMissing(station.latitude) || isMissing(station.longitude) || Number.isNaN(lat) || Number.isNaN(lon)) {
        return { href: '#', disabled: true };
      }
      return { href: `https://www.google.com/maps?q=${lat},${lon}`, disabled: false };
    }

    function percentTone(value) {
      if (isMissing(value) || Number.isNaN(Number(value))) {
        return { className: 'status-missing', label: 'No normal data' };
      }
      const num = Number(value);
      if (num < 75) return { className: 'status-below', label: 'Below normal' };
      if (num > 125) return { className: 'status-above', label: 'Above normal' };
      return { className: 'status-near', label: 'Near normal' };
    }

    function normalTone(value) {
      if (isMissing(value) || Number.isNaN(Number(value))) {
        return { className: 'status-missing', label: 'No normal data' };
      } else {
        return { label: 'Valid data' };
      }
    }

    function setStatus(message) {
      statusEl.textContent = message;
    }

    function showError(message) {
      errorEl.textContent = message;
      errorEl.classList.add('visible');
    }

    function clearError() {
      errorEl.textContent = '';
      errorEl.classList.remove('visible');
    }

    function renderCards(stations) {
      cardsEl.innerHTML = '';
      if (!stations.length) {
        emptyStateEl.hidden = false;
        return;
      }
      emptyStateEl.hidden = true;

      stations.forEach((station) => {
        const percent = percentTone(station.percentOfNorm);
        const normal = normalTone(station.waterYearNormIN);
        const map = mapLink(station);
        const stid = station.stid || '';
        const pinned = isPinned(station);
        const card = document.createElement('article');
        card.className = `station-card${pinned ? ' pinned' : ''}`;
        card.innerHTML = `
          <button class="pin-button${pinned ? ' is-pinned' : ''}" type="button" aria-pressed="${pinned}" aria-label="${pinned ? 'Unpin' : 'Pin'} station ${stid || station.name || ''}" data-stid="${stid}">
            <span class="pin-icon" aria-hidden="true"></span>
          </button>
          <div class="card-header" title="Station ${station.stid}">
            <div class="card-title">
              <span class="station-id">${station.stid || '-'}</span>
              <h3 class="station-name">${station.name || '-'}</h3>
            </div>
            <div class="current-temp" title="Current air temperature">
              <span class="current-label">Now:</span>
              <span class="current-value">${formatNumber(station.airTempF, 0, '°F')}</span>
            </div>
          </div>
          <div class="meta">
            <span title="Local observation time">Updated ${formatDate(station.dateTime)}</span>
          </div>
          <div class="metrics">
            <div class="metric">
              <div class="metric-label">High</div>
              <div class="metric-value">${formatNumber(station.dailyMaxF, 0, '°F')}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Low</div>
              <div class="metric-value">${formatNumber(station.dailyMinF, 0, '°F')}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Precip</div>
              <div class="metric-value">${formatNumber(station.dailyAccumIN, 2, '"')}</div>
            </div>
            <div class="metric">
              <div class="metric-label">Since Oct 1</div>
              <div class="metric-value">${formatNumber(station.waterYearIN, 2, '"')}</div>
            </div>
            <div class="metric ${normal.className}">
              <div class="metric-label">Normal</div>
              <div class="metric-value">${formatNumber(station.waterYearNormIN, 2, '"')}</div>
            </div>
            <div class="metric ${percent.className}">
              <div class="metric-label">Percent of Normal</div>
              <div class="metric-value">${formatPercent(station.percentOfNorm)}</div>
            </div>
          </div>
          <div class="card-footer">
            <a class="map-link${map.disabled ? ' disabled' : ''}" href="${map.href}" target="_blank" rel="noopener noreferrer"${map.disabled ? ' aria-disabled="true"' : ''}>Where is this station?</a>
          </div>
        `;

        cardsEl.appendChild(card);
      });
    }

    function compare(a, b, key) {
      const aVal = a[key];
      const bVal = b[key];
      const aMissing = isMissing(aVal);
      const bMissing = isMissing(bVal);

      if (aMissing && bMissing) return 0;
      if (aMissing) return 1;
      if (bMissing) return -1;

      if (key === 'stid' || key === 'name') {
        return String(aVal).localeCompare(String(bVal));
      }
      const numA = Number(aVal);
      const numB = Number(bVal);
      if (Number.isNaN(numA) && Number.isNaN(numB)) return 0;
      if (Number.isNaN(numA)) return 1;
      if (Number.isNaN(numB)) return -1;
      return numA === numB ? 0 : numA > numB ? 1 : -1;
    }

    function sortStations(list) {
      const direction = state.sortDir === 'asc' ? 1 : -1;
      return [...list].sort((a, b) => direction * compare(a, b, state.sortKey));
    }

    function getPinnedStations(sourceStations) {
      if (!state.pinned.size) return [];
      return sourceStations.filter((station) => state.pinned.has(String(station.stid)));
    }

    function getFilteredStations(sourceStations) {
      const query = searchInput.value.trim().toLowerCase();
      let filtered = [...sourceStations];

      if (query) {
        filtered = filtered.filter((station) =>
          String(station.stid || '').toLowerCase().includes(query) ||
          String(station.name || '').toLowerCase().includes(query)
        );
      }

      const pinnedStations = sortStations(getPinnedStations(sourceStations));
      const sortedFiltered = sortStations(filtered);
      const pinnedIds = new Set(pinnedStations.map((station) => String(station.stid)));
      const unpinnedFiltered = sortedFiltered.filter((station) => !pinnedIds.has(String(station.stid)));

      return [...pinnedStations, ...unpinnedFiltered];
    }

    function applyFilters() {
      const filtered = getFilteredStations(state.stations);
      state.filteredStations = filtered;
      renderCards(filtered);
      const pinnedCount = getPinnedStations(state.stations).length;
      const pinnedLabel = pinnedCount ? ` (${pinnedCount} pinned)` : '';
      setStatus(filtered.length ? `Showing ${filtered.length} station${filtered.length === 1 ? '' : 's'}${pinnedLabel}.` : 'No matching stations.');
    }

    async function loadData() {
      setStatus('Loading stations...');
      clearError();

      try {
        const response = await fetch('station_payloads.json', { cache: 'no-cache' }); //   '/source/mtr/climateWeb/station_payloads.json' 
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const json = await response.json();
        if (!json || !Array.isArray(json.data)) {
          throw new Error('Data array missing in payload.');
        }
        state.stations = json.data;
        state.meta = json.meta || {};
        applyFilters();
        setStatus(`Loaded ${state.stations.length} station${state.stations.length === 1 ? '' : 's'}.`);
      } catch (err) {
        showError(`Unable to load climate data. ${err.message}`);
        setStatus('');
      }
    }

    async function loadYesterdayData() {
      if (state.yesterdayStations.length) return state.yesterdayStations;

      try {
        const response = await fetch('/source/mtr/climateWeb/station_payloads_yesterday.json', { cache: 'no-cache' });
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        const json = await response.json();
        if (!json || !Array.isArray(json.data)) {
          throw new Error('Data array missing in yesterday payload.');
        }
        state.yesterdayStations = json.data;
        state.yesterdayMeta = json.meta || {};
        return state.yesterdayStations;
      } catch (err) {
        alert(`Unable to load yesterday's report data. ${err.message}`);
        return null;
      }
    }

    function toggleSortDirection() {
      state.sortDir = state.sortDir === 'asc' ? 'desc' : 'asc';
      sortDirectionBtn.textContent = state.sortDir === 'asc' ? 'Ascending' : 'Descending';
      sortDirectionBtn.setAttribute('aria-label', `Sort ${state.sortDir === 'asc' ? 'ascending' : 'descending'}`);
      applyFilters();
    }

    function toggleNotes() {
      const isCollapsed = notesSection.classList.toggle('collapsed');
      notesToggle.textContent = isCollapsed ? 'Show' : 'Hide';
      notesToggle.setAttribute('aria-expanded', (!isCollapsed).toString());
    }

    function togglePin(stid) {
      const key = String(stid || '');
      if (!key) return;

      if (state.pinned.has(key)) {
        state.pinned.delete(key);
      } else {
        state.pinned.add(key);
      }
      applyFilters();
    }

    function handlePinClick(event) {
      const pinButton = event.target.closest('.pin-button');
      if (!pinButton) return;
      const { stid } = pinButton.dataset;
      togglePin(stid);
    }

    function escapeHtml(text) {
      return String(text).replace(/[&<>"']/g, (char) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[char] || char));
    }

    function generateReportText(stations, meta = {}, contextLabel = '') {
      const fallbackNow = new Date();
      const generatedAt = meta.generatedAt ? new Date(meta.generatedAt) : fallbackNow;
      const daySource = meta.climateDayStart || meta.climateDayLabel;
      const reportDayRaw = daySource ? new Date(daySource) : generatedAt;
      const reportDay = Number.isNaN(reportDayRaw.getTime()) ? fallbackNow : reportDayRaw;

      const reportDateLabel = reportDay.toLocaleString(undefined, {
        month: 'numeric',
        day: 'numeric',
        year: 'numeric'
      });
      const headingContext = contextLabel ? ` (${contextLabel})` : '';

      const columns = [
        'Site',
        'High',
        'Low',
        'Precip',
        'Water Year',
        'Normal',
        '% of Normal'
      ];

      const header = [
        `Daily Climate Report ${reportDateLabel}${headingContext}`,
        'National Weather Service San Francisco CA',
        generatedAt.toLocaleString(undefined, {
          weekday: 'short',
          month: 'short',
          day: 'numeric',
          year: 'numeric',
          hour: 'numeric',
          minute: '2-digit',
          timeZoneName: 'short'
        }),
        'Daily observations are since 0800 GMT',
        `Stations included: ${stations.length}`,
        ''
      ];

      const rows = stations.map((station) => ([
        `${station.stid}`,
        formatNumber(station.dailyMaxF, 0),
        formatNumber(station.dailyMinF, 0),
        formatNumber(station.dailyAccumIN, 2),
        formatNumber(station.waterYearIN, 2),
        formatNumber(station.waterYearNormIN, 2),
        formatPercent(station.percentOfNorm)
      ].join('........')));

      const headerLine = columns.join('      ');
      const divider = '-'.repeat(headerLine.length);
      const title = `Daily_Climate_Report_${reportDay.getFullYear()}_${String(reportDay.getMonth() + 1).padStart(2, '0')}_${String(reportDay.getDate()).padStart(2, '0')}`;

      return { text: [...header, headerLine, divider, ...rows].join('\n'), title };
    }

    function openReportWindow(report) {
      const reportWindow = window.open('', '_blank');

      if (!reportWindow) {
        alert('Unable to open print view. Please allow pop-ups for this site.');
        return;
      }

      reportWindow.document.title = report.title;
      reportWindow.document.body.innerHTML = `<pre style="white-space: pre-wrap; font: 14px/1.5 monospace; margin: 16px;">${escapeHtml(report.text)}</pre>`;
      reportWindow.focus();
      reportWindow.print();
    }

    function openPrintReport() {
      const stationsForReport = getFilteredStations(state.stations);
      if (!stationsForReport.length) {
        alert('No station data to print yet. Please load data first.');
        return;
      }

      const report = generateReportText(stationsForReport, state.meta, 'Today');
      openReportWindow(report);
    }

    async function openYesterdayReport() {
      const yesterdayData = await loadYesterdayData();
      if (!yesterdayData || !yesterdayData.length) {
        return;
      }

      const stationsForReport = getFilteredStations(yesterdayData);
      if (!stationsForReport.length) {
        alert('No yesterday station data to print.');
        return;
      }

      const report = generateReportText(stationsForReport, state.yesterdayMeta, 'Yesterday');
      openReportWindow(report);
    }

    searchInput.addEventListener('input', applyFilters);
    sortBy.addEventListener('change', (event) => {
      state.sortKey = event.target.value;
      applyFilters();
    });
    cardsEl.addEventListener('click', handlePinClick);
    sortDirectionBtn.addEventListener('click', toggleSortDirection);
    notesToggle.addEventListener('click', toggleNotes);
    printButton.addEventListener('click', openPrintReport);
    yesterdayButton.addEventListener('click', () => { void openYesterdayReport(); });

    loadData();

  //   if (window.$) {
  //     $(function(){
  //     // hide the WFO level menus
  //     //$('.subMenuNav').hide();
  //     //$('.subMenuNav').remove();
  //     $('ul#subMenuNav li').css({ 'margin-right': '25px' });
  //     // reduce breadcrumb margin-bottom
  //     $('.breadcrumb').css({ 'margin-bottom': '0px' });
  //     // hide the big green "customize your weather.gov" box on the left
  //     $('#myfcst-widget').hide();
  //     // additional formatting to pull everything back to the left and style the borders, h/t WFOs ICT/btv
  //     $('.full-width-border').css('border-top', 'white');
  //     $('.partial-width-borderbottom').css('border-bottom', 'white');
      
  //     $('.five-sixth-first').css({
  //       'width' : '100%',
  //       'padding-right': '0px',
  //       'padding-left': '0px'
  //     });

  //     $('.content').css({
  //       'width': '1200px',
  //       'margin-right': 'auto',
  //       'margin-left': 'auto'
  //     });

  //     $('.center-content').css({
  //       'width': '1200px',
  //       'margin-right': 'auto',
  //       'margin-left': 'auto',
  //       'overflow': 'hidden'
  //     });

  //     $('.header').css({
	//     'margin': '0',
	//     'height': '60px',
  //       'width': '100%',
  //       'background-color': '#C5E5F5',
  //       'background-image': 'url(https://www.weather.gov/css/images/bg.png)',
  //       'background-repeat': 'repeat-y',
  //       'background-position': 'center top',
  //       'background-size': '2000px',
  //       'overflow': 'visible'
  //     });

  //     $('.header-content').css({
	//     'margin': '0 auto',
	//     'height': '60px',
	//     'width': '1238px',
  //       'overflow': 'visible'
  //     });

  //     $('.header-shadow').css({
	//     'height': '10px',
  //       'width': '100%',
  //       'background-color': '#C5E5F5',
  //       'background-image': 'url(https://www.weather.gov/css/images/bg.png)',
  //       'background-repeat': 'repeat-x',
  //       'background-position': 'center',
  //       'background-size': '1998px',
  //     });

  //     $('.header-shadow-content').css({
	//     'margin': '0px auto',
	//     'width': '1238px',
	//     'height': '10px',
	//     'background': 'url(https://www.weather.gov/css/images/head_shadow.png) center'	
  //     });

  //     $('.footer').css({
	//     'width': '100%',
	//     'background-color': '#C5E5F5',
  //       'background-image': 'url(https://www.weather.gov/css/images/bg_footer.png)',
  //       'background-repeat': 'repeat-y',
  //       'background-position': 'center',
  //       'background-size': '2000px',
	//     'visibility': 'visible',
	//     'overflow': 'visible',
	//     //'border-bottom': '4px double #1763ab'
  //     });

  //     $('.footer-content').css({
	//     'width': '1238px',
	//     'padding-left': '15px',
	//     'padding-right': '15px',
	//     'margin-left': 'auto',
	//     'margin-right': 'auto',
	//     'overflow': 'hidden',
	//     'line-height': '16px',
	//     'border-top': '4px double #1763ab',
	//     'border-bottom': '4px double #1763ab'
	//   });

  //     $('.footer-legal').css({
	//     'background-color': '#C5E5F5',
  //       'background-image': 'url(https://www.weather.gov/css/images/bg.png)',
  //       'background-repeat': 'repeat-y',
  //       'background-position': 'center',
  //       'background-size': '2000px',
	//     'width': '100%',
	//     'visibility': 'visible',
	//     'overflow': 'hidden',
	//     'padding-bottom': '10px'
  //     });

  //     $('.footer-legal-content').css({
	//     'width': '1238px',
	//     'margin-left': 'auto',
	//     'margin-right': 'auto',
	//     'overflow': 'hidden',
	//     'line-height': '16px',
	//     'padding-top': '15px'
  //     });

  //     $('.center, body').css({
  //       'width': '100%',
  //       'background-color': '#C5E5F5',
  //       'background-image': 'url(https://www.weather.gov/css/images/bg.png)',
  //       'background-repeat': 'repeat-y',
  //       'background-position': 'center top',
  //       'background-size': '2000px',
  //       'overflow': 'visible',
  //     });


  //     // hide the tiles on the bottom of the page since their content is already shown elsewhere on the page
  //     //$('div.div-full.mod-image-tiles').hide();
  //     // hide the national footer
  //     //$('div.footer-content').hide();
  //     // hide the local Top News section
  //     //$('div#topnews').hide();
  //     // hide the invisible element just below the forecast search box that's pushing the rest of the page content farther down
  //     $('div#sidebar.one-sixth-first').hide();
  //     // move the forecast search box from the top of the screen to where it used to be on the pre-NIDS EM page
  //     $('div#forecast-lookup').appendTo('div#fcst');
  //     // re-style the forecast search box's "Go" button to match the rest of the page
  //     //$('input#btnSearch').button();
  //     // hide the top navigation bar
  //     //$('div.topnav').hide();
  //     // Uncomment the next line to hide the Twitter/FB/YouTube/RSS links at the bottom of the page.
  //     //$('div.full-width-first.communication-links').hide();
      
  //     });
  //   }
    
  </script>
</body>
</html>
